version: '2'
services:
  mongodb:
    image: mongo:4.0
    user: "root"
    restart: always
    command: mongod --storageEngine mmapv1
    # command: tail -f /dev/null
    volumes:
      # [local directory]:[container directory]
      - ../../db/mongodb:/data
      # [local file]:[container file]
      - "./mongodb/mongod.conf:/etc/mongod.conf"
    ports:
      - 27017:27017
    networks:
      - backend
  nginx-proxy:
    image: nginx:stable
    user: "root"
    restart: always
    volumes:
      - "./nginx/nginx.conf:/etc/nginx/nginx.conf"
      - ../../www-static/:/www-static
      - ../../app/content/public/:/www-content
      - shared_tmp:/shared
    ports:
      # [local port]:[container port]
      - 80:80
    networks:
      - backend
    depends_on:
      - express-content
      # - express-feedback
  express-content:
    tty: true # Enables debugging capabilities when attached to this container.
    image: base-express
    user: "root"
    restart: "always"
    command:  /bin/sh -c "yarn --cwd api build && node api/dist/bootstrap.js"
    # We are not using any of the environment setup w/in the express config... but it might be nice to
    environment:
      - DATABASE_URL=mongodb://mongodb:27017/content
      - SKIP_DB_WAIT=0
      - SKIP_DB_MIGRATION=0
      - SKIP_NPM_INSTALL=0
      - SKIP_BOWER_INSTALL=0
    depends_on:
      - mongodb
    ports:
      - 5102:5101
    volumes:
      - shared_tmp:/shared
      - ../../app/content:/root/app
      - ../../api/content_api:/root/api
    networks:
      - backend
  # express-feedback:
  #   tty: true # Enables debugging capabilities when attached to this container.
  #   image: base-express
  #   user: "root"
  #   restart: "always"
  #   command:  /bin/sh -c "yarn --cwd api build && node api/dist/bootstrap.js"
  #   environment:
  #     - DATABASE_URL=mongodb://mongodb:27017/content
  #     - SKIP_DB_WAIT=0
  #     - SKIP_DB_MIGRATION=0
  #     - SKIP_NPM_INSTALL=0
  #     - SKIP_BOWER_INSTALL=0
  #   depends_on:
  #     - mongodb
  #   ports:
  #     - 5103:5101
  #   volumes:
  #     - ../../app/feedback:/root/app
  #     - ../../api/feedback_api:/root/api
  #     - shared_tmp:/shared
  #   networks:
  #     - backend
networks:
  backend:

volumes:
  shared_tmp:
    driver_opts:
      type: tmpfs
      device: tmpfs
