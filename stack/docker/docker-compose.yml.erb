version: '2'
services:
  nginx-proxy:
    image: nginx:stable
    user: "root"
    restart: always
    volumes:
      - "./nginx/nginx.conf:/etc/nginx/nginx.conf"
      - ../../www-static:/www-static
      - ../../app/content:/vue_app
      - /shared/pool/ingest/content:/shared
      - /tmp/pool/ingest/content:/shared_tmp
    ports:
      # [local port]:[container port]
      - <%= nginx_port %>:80
    networks:
      - backend
    depends_on:
      - express-content
      # - express-feedback
  express-content:
    # tty: true # Enables debugging capabilities when attached to this container.
    # image: base-express
    image: bmilne/express:1.0
    user: "root"
    restart: "always"
    command:  /bin/sh -c "yarn --cwd api build && node api/dist/bootstrap.js"
    #command: tail -f /dev/null
    environment:
      - HOST_IP=<%= my_ip_address %>
      - DATATBASE_URL=mongodb://10.0.1.3:27017
      - MONGO_DBNAME=internal_tools_jester
      # - DATABASE_URL=mongodb://mongodb:27017
      # - SKIP_DB_WAIT=0
      # - SKIP_DB_MIGRATION=0
      # - SKIP_NPM_INSTALL=0
      # - SKIP_BOWER_INSTALL=0
    ports:
      - 5102:5101
    volumes:
      - /shared/pool/ingest/content:/shared
      - /tmp/pool/ingest/content:/shared_tmp
      - ../../app/content:/root/app
      - ../../api/content_api:/root/api
    networks:
      - backend
  coproc:
    # tty: true # Enables debugging capabilities when attached to this container.
    image: bmilne/pyco:1.0
    # image: python-coproc
    user: "root"
    restart: "always"
    command:  python /app/app.py
    environment:
      - HOST_IP=<%= my_ip_address %>
      - MONGO_URL=mongodb://10.0.1.3:27017
      - MONGO_DBNAME=internal_tools
    volumes:
      - /shared/pool/ingest/content:/shared
      - /tmp/pool/ingest/content:/shared_tmp
      - ../../python/docker/python-coproc:/app
      - ../../python/docker/modules:/modules
      - ../../python/docker/data:/data
    networks:
      - backend

networks:
  backend:

volumes:
  shared_tmp:
    driver_opts:
      type: tmpfs
      device: tmpfs
