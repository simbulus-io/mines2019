version: '2'
services:
  nginx-proxy:
    image: nginx:stable
    user: "root"
    restart: always
    volumes:
      - "./nginx/nginx.conf:/etc/nginx/nginx.conf"
      - ../../www-static:/www-static
      - ../../app/content:/vue_app
      - <%= opts.share %>/pool/ingest/content:/shared
      - shared_tmp:/shared_tmp
    ports:
      # [local port]:[container port]
      - <%= opts.port %>:80
    networks:
      - backend
    depends_on:
      - express-content
      # - express-feedback
  express-content:
    # tty: true # Enables debugging capabilities when attached to this container.
    # image: base-express
    image: bmilne/express:1.0
    user: "root"
    restart: "always"
    command:  /bin/sh -c "yarn --cwd api build && node api/dist/bootstrap.js"
    #command: tail -f /dev/null
    environment:
      - HOST_IP=<%= my_ip_address %>
      - DATABASE_URL=<%= opts.mongo_url %>
      - MONGO_DBNAME=<%= opts.mongo_db_name %>
    ports:
      - 5102:5101
    volumes:
      - <%= opts.share %>/pool/ingest/content:/shared
      - shared_tmp:/shared_tmp
      - ../../app/content:/root/app
      - ../../api/content_api:/root/api
    networks:
      - backend
  coproc:
    # tty: true # Enables debugging capabilities when attached to this container.
    # image: bmilne/pyco:1.0
    image: python-coproc
    user: "root"
    restart: "always"
    command:  python /app/app.py
    environment:
      - HOST_IP=<%= my_ip_address %>
      - DATABASE_URL=<%= opts.mongo_url %>
      - MONGO_DBNAME=<%= opts.mongo_db_name %>
    volumes:
      - <%= opts.share %>/pool/ingest/content:/shared
      - shared_tmp:/shared_tmp
      - ../../python/python-coproc:/app
      - ../../python/modules:/modules
      - ../../python/data:/data
    networks:
      - backend

networks:
  backend:

volumes:
  shared_tmp:
    driver_opts:
      type: tmpfs
      device: tmpfs
